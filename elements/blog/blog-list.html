
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link href="../../bower_components/core-animated-pages/transitions/slide-up.html" rel="import">
<link href="../../bower_components/core-animated-pages/transitions/list-cascade.html" rel="import">

<link rel="import" href="blog-card.html">
<link rel="import" href="blog-content.html">

<polymer-element name="blog-list">
  <template>
    <style>
      :host{
        height: 100%
      }
      #container{
        overflow: auto;
      }
      .card{
        text-align: left;
        background: white;
        margin-bottom: 10px;
        margin-top: 10px;
        width:400px;
        min-height: 200px;
      }
      .view {
        background-color: #fff;
      }
      .blog-card{
        background: #fff;
      }
    </style>
    <core-ajax
    id="ajax" auto
    url="https://api.myjson.com/bins/2yku7"
    handleAs="json"
    response="{{response}}"
    progress="{{progress}}"
    loading="{{loading}}"
    ></core-ajax>

    <core-ajax
    id="gistAjax"
    url="https://api.myjson.com/bins/4x46v"
    handleAs="json"
    response="{{gistresponse}}"
    progress="{{gistprogress}}"
    loading="{{gistloading}}"
    ></core-ajax>

    <section flex vertical layout>
      <core-animated-pages flex id="pages" selected="0" on-core-animated-pages-transition-end="{{transitionend}}" transitions="cross-fade-all hero-transition slide-up slide-down cross-fade list-cascade">

        <section vertical layout>
          <div id="container" horizontal flex wrap around-justified layout hero-p>

            <div layout vertical center-justified hidden?="{{response}}">
              <paper-spinner active></paper-spinner>
            </div>

            <template repeat="{{blog, i in blogs}}">
              	<blog-card class="card" on-tap="{{selection}}" hero-id="blog-{{i}}" hero>
                    <img src="{{blog.owner.avatar_url}}" width="70" height="70">
                    <h2>{{blog.description}}</h2>
                    <p>{{blog.updated_at}}</p>
                    {{i}}{{lastSelected}}
          	    </blog-card>
            </template>

          </div>
        </section>

        <template repeat="{{blog, i in blogs}}" id="blogContent">
            <section vertical layout>

              <div class="view" hero-id="blog-{{i}}" flex vertical layout hero>
                  <core-icon-button icon="arrow-back" on-tap="{{back}}"></core-icon-button>
                  <blog-content content="{{content}}" index="{{$.pages.selected}}">
                    <h2 class="title" cross-fade>{{blogTitle}}</h2>
                  </blog-content>
              </div>

            </section>
        </template>

       </core-animated-pages>
     </section>

  </template>

  <script>
  	Polymer('blog-list', {
		  responseChanged: function(oldValue) {
		    this.blogs = this.response;
		  },
      selection: function(e){
        var k = e.target.templateInstance.model.i;
        this.$.pages.selected = k+1;
        var blog = e.target.templateInstance.model.blog;
        this.blogTitle = blog.description; 
        this.$.gistAjax.go();
      },
      transitionend: function(){
        if (this.lastSelected) {
          this.lastSelected = null;
        }
      },
      back: function() {
        this.lastSelected = this.$.pages.selected;
        this.$.pages.selected = 0;
      },
      gistresponseChanged: function(e, detail){
        if(this.$.gistAjax.response != null){
          this.gist = this.$.gistAjax.response;
          return false;
        }
        var files = this.gist.files;
        var contentFile;
        for (var i in files) {
            if (files.hasOwnProperty(i) && typeof(i) !== 'function') {
                contentFile = files[i];
                break;
            }
        }
        this.content = markdown.toHTML(contentFile.content);
        this.renderContent();
        // this.injectBoundHTML(this.content, this.$.pages.lastSelected.firstElementChild);
        // console.log(this.$.pages.selectedItem);
        // console.log(this.$.pages.lastSelected);
        // console.log(document.querySelector('blogContent').options[this.$.pages.selected]);
        // console.log(document.querySelector('template').model);
      },
      renderContent: function(){
        alert("dsf");
        // this.innerHTML = this.html;
      }
      
	  });
  </script>
   <script src="../../bower_components/markdown/lib/markdown.js"></script>

</polymer-element>